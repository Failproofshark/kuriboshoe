var select2={};select2.config=function(e){return function(r,t){var n=$(r);t||(e.select2InitializationOptions?n.select2(e.select2InitializationOptions):n.select2(),n.change(function(){m.startComputation(),e.onchange(n.select2("val")),m.endComputation()})),n.select2("val",e.value)}},select2.view=function(e,r,t){var n=t?"select.form-control[multiple=true]":"select.form-control",o=function(){var e=[];return r&&(e=_.map(r,function(e){var r=_.isObject(e)?m("option",{value:e.id},e.name):m("option",e);return r})),e};return m(n,{config:select2.config(e)},[m("option"),o()])};var GameTrackerShared={};GameTrackerShared.TrackerForm=function(e){this.fields=e,this.populateForm=function(e){var r=this;e.attributes?_.map(e.attributes,function(e,t){"id"!==t&&r.fields[t](e)}):_.map(e,function(e,t){"id"!==t&&r.fields[t](e)})},this.clearForm=_.forEach.bind(this,this.fields,function(e){e(_.isString(e())?"":_.isArray(e())?[]:_.isBoolean(e())?!1:null)}),this.returnFields=function(){return _.mapValues(this.fields,function(e){var r=e();return _.isBoolean(r)&&(r=Number(r)),r})},this.submitHandlers={},this.submitHandlers.search=function(){},this.getSubmitHandler=function(e){return this.submitHandlers[e]}};var GameForm={};GameForm.controller=new function(){this.gameForm=new GameTrackerShared.TrackerForm({name:m.prop(""),blurb:m.prop(""),region:m.prop(""),hasmanual:m.prop(0),hasbox:m.prop(0),notes:m.prop(""),quantity:m.prop(""),genres:m.prop([]),companies:m.prop([]),systemid:m.prop("")}),this.errorMessage="",this.isLoading=!1,this.searchResults=[],this.noResults="",this.formMode="search",this.isAdmin=!1,this.searchLoading=!1,this.selectUpdateHandler,this.selectDeleteHandler,this.cancelButtonHandler,this.systems,this.genres,this.companies,this.addCompanyHandler=function(){},this.addGenreHandler=function(){},this.addSystemHandler=function(){},this.populateSelectDataSets=function(e,r,t){this.systems=e,this.genres=r,this.companies=t},this.adminResultButtonHandlers=function(e,r){this.selectUpdateHandler=e,this.selectDeleteHandler=r},this.bindSubmitFormHandler=function(e,r){this.gameForm.submitHandlers[e]=r},this.titleClickHandler=function(){},this.gameForm.submitHandlers.search=function(){GameForm.controller.noResults="",GameForm.controller.isLoading=!0;var e=_.omit(GameForm.controller.gameForm.returnFields(),function(e){var r=!0;return _.isBoolean(e)?r=!e:_.isEmpty(e)||(r=!1),r});return _.isEmpty(e)?(GameForm.controller.errorMessage="Please enter at least one search parameter",GameForm.controller.isLoading=!1):(GameForm.controller.errorMessage="",m.request({method:"post",url:"/search-games-ajax/",data:e}).then(function(e){GameForm.controller.searchResults=_.remove(e.results,function(e){return!_.isNull(e)}),GameForm.controller.searchResults.length<1&&(GameForm.controller.noResults="No matches were found"),GameForm.controller.isLoading=!1},function(){GameForm.controller.errorMessage="Internal Server Error"})),!1}},GameForm.view=function(){var e={textAreaDisplay:function(){var e="search"===GameForm.controller.formMode?"display:none":"display:inherit";return e},actionButtonDisplay:function(){var e=GameForm.controller.isLoading?"display:none":"display:inline";return e},preloaderDisplay:function(){var e=GameForm.controller.isLoading?"display:inherit":"display:none";return e},changeFormProperties:function(){var e="cursor:pointer;";return e+=GameForm.controller.isAdmin?"display:inherit":"display:none"}},r=function(){var e=[],r=GameForm.controller.searchLoading?{results:"display:none",preloader:"display:inherit"}:{results:"display:inherit",preloader:"display:none"},t=GameForm.controller.isAdmin?"cursor:default":"cursor:pointer",n=function(e){var r=[];return GameForm.controller.isAdmin&&(r=m("div.col-xs-3",[m("span.glyphicon.glyphicon-remove.game-search-results-button",{onclick:GameForm.controller.selectDeleteHandler.bind(GameForm.controller,e.id)}),m("span.glyphicon.glyphicon-pencil.game-search-results-button",{onclick:GameForm.controller.selectUpdateHandler.bind(GameForm.controller,e.id)})])),r};return _.isEmpty(GameForm.controller.searchResults)&&_.isEmpty(GameForm.controller.noResults)||(e=m("div",{style:r.results},[m("div",GameForm.controller.noResults),_.map(GameForm.controller.searchResults,function(e,r){var o="background-color:#CECFE0";return r%2==0&&(o="background-color:#FFF"),m("div.row.result-row",{style:o},[m("div.col-xs-9",{style:o},[m("span",{style:t,onclick:GameForm.controller.titleClickHandler.bind(GameForm.controller,e.id)},e.name+" ["+e.region+"] ("+e.systemName+")")]),n(e)])}),m("img[src=/images/ajax.gif]",{style:r.preloader})])),e};return[m("div.row",[m("div.col-xs-12",[m("div.text-danger",GameForm.controller.errorMessage),m("form",[m("input.form-control",{onchange:m.withAttr("value",GameForm.controller.gameForm.fields.name),value:GameForm.controller.gameForm.fields.name(),placeholder:"Name"}),select2.view({onchange:GameForm.controller.gameForm.fields.region,value:GameForm.controller.gameForm.fields.region(),select2InitializationOptions:{placeholder:"Region",allowClear:!0}},["NTSC","NTSC-J","PAL"]),m("div",[select2.view({onchange:GameForm.controller.gameForm.fields.systemid,value:GameForm.controller.gameForm.fields.systemid(),select2InitializationOptions:{placeholder:"System",allowClear:!0}},GameForm.controller.systems),m("u",{style:e.changeFormProperties(),onclick:GameForm.controller.addSystemHandler},"+Add System")]),m("div",[select2.view({onchange:GameForm.controller.gameForm.fields.genres,value:GameForm.controller.gameForm.fields.genres(),select2InitializationOptions:{placeholder:"Genres",allowClear:!0}},GameForm.controller.genres,!0),m("u",{style:e.changeFormProperties(),onclick:GameForm.controller.addGenreHandler},"+Add Genre")]),m("div",[select2.view({onchange:GameForm.controller.gameForm.fields.companies,value:GameForm.controller.gameForm.fields.companies(),select2InitializationOptions:{placeholder:"Companies",allowClear:!0}},GameForm.controller.companies,!0),m("u",{style:e.changeFormProperties(),onclick:GameForm.controller.addCompanyHandler},"+Add Company")]),m("input.form-control",{onchange:m.withAttr("value",GameForm.controller.gameForm.fields.quantity),value:GameForm.controller.gameForm.fields.quantity(),placeholder:"Quantity"}),m("div",{style:e.textAreaDisplay()},[m("p","Short Description"),m("textarea",{onchange:m.withAttr("value",GameForm.controller.gameForm.fields.blurb)},GameForm.controller.gameForm.fields.blurb())]),m("div.checkbox",[m("label",[m("input[type=checkbox]",{onchange:m.withAttr("checked",GameForm.controller.gameForm.fields.hasmanual),checked:GameForm.controller.gameForm.fields.hasmanual()})]),m("span","Manual")]),m("div.checkbox",[m("label",[m("input[type=checkbox]",{onchange:m.withAttr("checked",GameForm.controller.gameForm.fields.hasbox),checked:GameForm.controller.gameForm.fields.hasbox()})]),m("span","Box")]),m("div",{style:e.textAreaDisplay()},[m("p","Notes"),m("textarea",{onchange:m.withAttr("value",GameForm.controller.gameForm.fields.notes)},GameForm.controller.gameForm.fields.notes())]),m("div",[m("button.btn.btn-success",{style:e.actionButtonDisplay(),onclick:GameForm.controller.gameForm.submitHandlers[GameForm.controller.formMode]},"submit"),m("button.btn.btn-danger",{style:e.actionButtonDisplay(),onclick:GameForm.controller.cancelButtonHandler},"cancel"),m("img[src=/images/ajax.gif]",{style:e.preloaderDisplay()})])])])]),r()]};var GameTrackerClient={};GameTrackerClient.Game=function(initialObject){this.attributes={name:initialObject.name,blurb:initialObject.blurb,region:initialObject.region,hasmanual:initialObject.hasmanual,hasbox:initialObject.hasbox,notes:initialObject.notes,quantity:initialObject.quantity,systemname:"",genres:[],companies:[]},this.attributes.systemname=_.result(_.find(systems,{id:initialObject.systemid}),"name");var ensureArray=function(e){var r=_.isArray(e)?e:[e];return r},getRelatedNames=function(collectionName){var singularName="genres"===collectionName?"genreId":"companyId";return _.pluck(_.filter(eval(collectionName),function(e){return _.contains(_.pluck(ensureArray(initialObject[collectionName]),singularName),e.id)}),"name")};this.attributes.genres=getRelatedNames("genres"),this.attributes.companies=getRelatedNames("companies")},GameTrackerClient.vm=new function(){var e={};return e.init=function(){GameForm.controller.isLoading=!1,GameForm.controller.isAdmin=!1,e.currentScreen="SearchScreen",e.shouldDisplayScreen=function(r){var t=r===e.currentScreen?"inherit":"none";return t},GameForm.controller.populateSelectDataSets(systems,genres,companies),GameForm.controller.cancelButtonHandler=function(){return GameForm.controller.gameForm.clearForm(),!1},e.currentGame=null,GameForm.controller.titleClickHandler=function(r){if(GameForm.controller.searchLoading=!0,r&&_.isFinite(Number(r))){m.request({method:"GET",url:"/game/",data:{id:Number(r)}}).then(function(r){r&&(e.currentGame=new GameTrackerClient.Game(r),e.currentScreen="InfoScreen",GameForm.controller.searchLoading=!1,GameForm.controller.searchResults=[],GameForm.controller.gameForm.clearForm())},e.reportInternalError)}}},e.returnToSearch=function(){e.currentScreen="SearchScreen",e.currentGame=null},e},GameTrackerClient.controller=function(){GameTrackerClient.vm.init()},GameTrackerClient.screenCollection={},GameTrackerClient.screenCollection.SearchScreen=function(){return[m("h1","Game Search"),m("div",[m("span","Fill in at least one search parameter below."),m("br"),m("em","e.g. To see all Super Famicom games, select Super Famicom in the System select drop down and click submit")]),GameForm.view()]},GameTrackerClient.screenCollection.InfoScreen=function(){var e=[];if(!_.isNull(GameTrackerClient.vm.currentGame)){var r=GameTrackerClient.vm.currentGame,t=function(){var e="Game only";return r.attributes.hasmanual&&r.attributes.hasbox?e="Complete In Box":r.attributes.hasmanual?e="Game and Manual":r.attributes.hasbox&&(e="Game and Box"),e};e=m("div.row",[m("div.col-xs-12",[m("h1","Game Data"),m("h2",r.attributes.name+" ("+r.attributes.systemname+")"),m("div",[m("strong","Condition: "),m("span",t())]),m("div",[m("strong","Region: "),m("span",r.attributes.region)]),m("div",[m("strong","Quantity: "),m("span",r.attributes.quantity)]),m("div",[m("strong","Genres: "),m("span",r.attributes.genres.join(", "))]),m("div",[m("strong","Companies: "),m("span",r.attributes.companies.join(", "))]),m("div",[m("h3","Blurb"),m("blockquote",r.attributes.blurb)]),m("div",[m("h3","Notes"),m("blockquote",r.attributes.notes)]),m("button.btn.btn-primary",{onclick:GameTrackerClient.vm.returnToSearch},"Back")])])}return e},GameTrackerClient.view=function(){var e=function(){return _.map(GameTrackerClient.screenCollection,function(e,r){return m("div",{style:"display:"+GameTrackerClient.vm.shouldDisplayScreen(r)},e())})};return e()},m.module(document.getElementById("container"),GameTrackerClient);